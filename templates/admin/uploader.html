{% extends "admin/base_site.html" %}
{% block content %}
<div class="container-fluid my-4">
  <div class="card shadow-lg w-100 h-100">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">ESP8266 Web Serial UI</h5>
    </div>
    <div class="card-body" style="min-height:70vh;">

      <!-- Command Input -->
      <div class="mb-3">
        <label for="command" class="form-label">Command</label>
        <input type="text" id="command" class="form-control" placeholder="Enter command here">
      </div>
      <div class="mb-3">
        <button class="btn btn-success me-2" onclick="writeCommand()">Write</button>
        <button class="btn btn-secondary" onclick="clearInput()">Clear Input</button>
      </div>

      <!-- Output Area -->
      <div class="mb-3">
        <label class="form-label">Output</label>
        <textarea id="output" class="form-control" rows="12" readonly style="min-height:40vh;"></textarea>
      </div>
      <div class="mb-3">
        <button class="btn btn-warning w-100" onclick="clearOutput()">Clear Output</button>
      </div>

      <!-- Serial Controls -->
      <div class="d-flex justify-content-between">
        <button class="btn btn-primary" onclick="connectSerial()">Connect Serial</button>
        <button class="btn btn-danger" onclick="disconnectSerial()">Disconnect</button>
      </div>
    </div>
  </div>
</div>

<script>
let port, reader, writer;

async function connectSerial() {
    try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    reader = port.readable.getReader();
    readLoop();
    log("‚úÖ Connected to serial port.");
    } catch (err) {
    log("‚ùå Error: " + err);
    }
}

async function disconnectSerial() {
    if (reader) {
    await reader.cancel();
    reader.releaseLock();
    }
    if (writer) {
    writer.releaseLock();
    }
    if (port) {
    await port.close();
    }
    log("üîå Disconnected.");
}

async function readLoop() {
    while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    if (value) {
        log(new TextDecoder().decode(value));
    }
    }
}

async function writeCommand() {
    const cmd = document.getElementById("command").value + "\n";
    if (writer) {
    await writer.write(new TextEncoder().encode(cmd));
    log("‚û°Ô∏è Sent: " + cmd.trim());
    } else {
    log("‚ö†Ô∏è Not connected.");
    }
}

function clearInput() {
    document.getElementById("command").value = "";
}

function clearOutput() {
    document.getElementById("output").value = "";
}

function log(msg) {
    const output = document.getElementById("output");
    output.value += msg + " ";
    output.scrollTop = output.scrollHeight;
}
</script>

{% endblock %}