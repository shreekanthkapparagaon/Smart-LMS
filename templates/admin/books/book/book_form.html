{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .form-text.text-success {
      font-weight: 500;
      margin-top: 5px;
    }
  </style>
{% endblock %}

{% block after_field_sets %}
  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="autoRecommend">
    <label class="form-check-label" for="autoRecommend">
      üì¶ Auto-recommend shelf based on book info
    </label>
  </div>

  <!-- ‚úÖ Toast (optional) -->
  <div id="recommendToast" class="toast text-bg-success position-fixed bottom-0 end-0 m-3" role="alert">
    <div class="d-flex">
      <div class="toast-body">
        ‚úÖ Shelf auto-filled: <span id="toastShelfAddr"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
{% endblock %}

{% block inline_script %}
  {{ block.super }}
<script>
  console.log("‚úÖ Custom admin JS loaded");  // üëà This should appear immediately

  document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ DOM fully loaded");  // üëà This confirms JS is running

    const checkbox = document.querySelector("#autoRecommend");
    if (!checkbox) {
      console.warn("‚ùå Checkbox not found");
      return;
    }

    checkbox.addEventListener("change", function () {
      console.log("üì¶ Checkbox checked");

      const name = document.querySelector("#id_name")?.value || "";
      const author = document.querySelector("#id_auther")?.value || "";
      const tagSelect = document.querySelector("#id_catagory");
      const selectedTags = Array.from(tagSelect?.selectedOptions || []).map(opt => opt.text);

      console.log("üìö Selected tags:", selectedTags);

      fetch(`/books/api/recommend-shelf/?name=${encodeURIComponent(name)}&author=${encodeURIComponent(author)}&` +
            selectedTags.map(tag => `tags[]=${encodeURIComponent(tag)}`).join("&"))
        .then(res => res.json())
        .then(data => {
          console.log("‚úÖ Recommended shelf address:", data.recommended_addr);
        })
        .catch(err => {
          console.error("‚ùå Shelf recommendation failed:", err);
        });
    });
  });
</script>
{% endblock %}
{% comment %} book1 = Book.objects.create(name="Galactic Drift", auther="A. Nova", addr=shelf1)
book1.catagory.set([scifi, short]) {% endcomment %}
